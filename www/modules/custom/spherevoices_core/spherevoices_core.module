<?php

/**
 * @file
 * Module file for SphereVoices Core.
 */

use Drupal\Core\Form\FormStateInterface;

/**
 * Implements hook_theme().
 */
function spherevoices_core_theme($existing, $type, $theme, $path) {
  return [
    'agenda_page' => [
      'variables' => [
        'search_form' => NULL,
        'events_html' => '',
        'count' => 0,
      ],
      'template' => 'agenda-page',
    ],
  ];
}

/**
 * Implements hook_form_BASE_FORM_ID_alter() for node_form.
 */
function spherevoices_core_form_node_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  $node = $form_state->getFormObject()->getEntity();
  
  // Masquer les options de publication pour le type de contenu Event
  if ($node->bundle() === 'event') {
    // Masquer complètement la section "Options de publication"
    if (isset($form['options'])) {
      $form['options']['#access'] = FALSE;
    }
    
    // Alternative : masquer les champs individuels tout en gardant la section
    if (isset($form['promote'])) {
      $form['promote']['#access'] = FALSE;
    }
    if (isset($form['sticky'])) {
      $form['sticky']['#access'] = FALSE;
    }
  }
}

/**
 * Implements hook_preprocess_image_widget().
 * 
 * Remplace la preview du widget d'image pour utiliser l'image originale au lieu du style thumbnail.
 */
function spherevoices_core_preprocess_image_widget(&$variables) {
  // Debug: vérifier si le hook est appelé
  \Drupal::logger('spherevoices_core')->notice('hook_preprocess_image_widget appelé');
  
  // Modifier la preview pour utiliser l'image originale
  if (!empty($variables['data']['preview'])) {
    \Drupal::logger('spherevoices_core')->notice('Preview trouvée dans data');
    
    // Récupérer le fichier depuis l'élément
    $element = $variables['element'];
    
    if (isset($element['#files']) && !empty($element['#files'])) {
      \Drupal::logger('spherevoices_core')->notice('Fichiers trouvés: @count', ['@count' => count($element['#files'])]);
      
      foreach ($element['#files'] as $file) {
        if ($file) {
          $uri = $file->getFileUri();
          
          // Créer l'URL absolue de l'image originale
          $url = \Drupal::service('file_url_generator')->generateAbsoluteString($uri);
          
          \Drupal::logger('spherevoices_core')->notice('URL générée: @url', ['@url' => $url]);
          
          $alt = '';
          
          // Récupérer l'alt text si disponible
          if (isset($element['#default_value']['alt'])) {
            $alt = $element['#default_value']['alt'];
          }
          
          // Remplacer complètement la preview avec l'image originale
          // Utiliser un render array simple avec l'URL directe
          $variables['data']['preview'] = [
            '#type' => 'html_tag',
            '#tag' => 'img',
            '#attributes' => [
              'src' => $url,
              'alt' => $alt,
              'class' => ['image-widget-preview'],
              'data-drupal-selector' => 'edit-field-image-0-preview',
              'loading' => 'lazy',
            ],
          ];
          
          \Drupal::logger('spherevoices_core')->notice('Preview remplacée avec URL: @url', ['@url' => $url]);
          
          break; // On ne traite que le premier fichier
        }
      }
    }
  }
}

